# Fastfile
require 'fileutils'
require 'json'

default_platform(:ios)

platform :ios do
  lane :build_framework do |options|
    # 1. æ¥æ”¶å¹¶è§£æ JSON æ ¼å¼å¯†é’¥ï¼Œè·å–æ‰€æœ‰ vfp å­—æ®µï¼ˆä»…è¿™ä¸€æ­¥åœ¨å¾ªç¯å¤–ï¼‰
    secret_json_str = options[:build_users]
    unless secret_json_str
      UI.user_error!("âŒ è¯·ä¼ å…¥ JSON æ ¼å¼å¯†é’¥ï¼šfastlane build_framework build_users:\"{ä½ çš„JSONå­—ç¬¦ä¸²}\"")
    end

    # è§£æ JSON å¹¶æå–æ‰€æœ‰ vfp å­—æ®µ
    begin
      secret_json = JSON.parse(secret_json_str)
      unless secret_json.key?("data") && secret_json["data"].is_a?(Array) && !secret_json["data"].empty?
        UI.user_error!("âŒ JSON æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘æœ‰æ•ˆçš„ data æ•°ç»„")
      end

      # æ”¶é›†æ‰€æœ‰æœ‰æ•ˆçš„ vfp å­—æ®µ
      vfp_list = secret_json["data"].each_with_index.map do |item, index|
        vfp = item["vfp"]&.to_s&.strip
        unless vfp && !vfp.empty?
          UI.user_error!("âŒ JSON æ ¼å¼é”™è¯¯ï¼šdata æ•°ç»„ç¬¬ #{index + 1} ä¸ªå…ƒç´ ç¼ºå°‘æœ‰æ•ˆçš„ vfp å­—æ®µ")
        end
        vfp
      end

      UI.success("âœ… æˆåŠŸè§£æ JSON å¯†é’¥ï¼Œå…±è·å– #{vfp_list.size} ä¸ª vfp å­—æ®µï¼Œå¼€å§‹å¾ªç¯å¤„ç†...")
    rescue JSON::ParserError => e
      UI.user_error!("âŒ JSON è§£æå¤±è´¥ï¼š#{e.message}")
    end

    # åŸºç¡€è·¯å¾„ï¼ˆå¾ªç¯å¤–å®šä¹‰å…¬å…±æ ¹ç›®å½•ï¼‰
    base_work_dir = "./build_multi_vfp"
    FileUtils.mkdir_p(base_work_dir)
    UI.message("ğŸ“‚ æ‰€æœ‰æ„å»ºçš„æ ¹ç›®å½•ï¼š#{base_work_dir}")

    # 2. éå†æ¯ä¸ª vfpï¼Œå°†æ­¥éª¤2-5å…¨éƒ¨çº³å…¥å¾ªç¯
    vfp_list.each_with_index do |current_vfp, index|
      UI.message("\n\n==================================================")
      UI.message("ğŸ”„ å¼€å§‹å¤„ç†ç¬¬ #{index + 1}/#{vfp_list.size} ä¸ª vfpï¼ˆéƒ¨åˆ†éšè—ï¼š#{current_vfp[0, 6]}...ï¼‰")
      UI.message("==================================================\n")

      # --------------------------
      # æ­¥éª¤2ï¼šå½“å‰ vfp çš„è·¯å¾„é…ç½®ï¼ˆå¾ªç¯å†…å®šä¹‰ï¼Œå®Œå…¨éš”ç¦»ï¼‰
      # --------------------------
      # å½“å‰ vfp çš„ç‹¬ç«‹å·¥ä½œç›®å½•ï¼ˆæ‰€æœ‰æ–‡ä»¶å‡åœ¨æ­¤ç›®å½•ï¼Œé¿å…äº¤å‰æ±¡æŸ“ï¼‰
      current_work_dir = "#{base_work_dir}/vfp_#{index + 1}"
      FileUtils.mkdir_p(current_work_dir)

      # å½“å‰ vfp çš„å¯†é’¥æ–‡ä»¶è·¯å¾„ï¼ˆç‹¬ç«‹è·¯å¾„ï¼Œé¿å…è¦†ç›–ï¼‰
      secret_file_path = "#{current_work_dir}/SecretKey.swift"
      
      # å½“å‰ vfp çš„ç¼–è¯‘è¾“å‡ºç›®å½•
      current_build_output = "#{current_work_dir}/framework"
      FileUtils.mkdir_p(current_build_output)
      
      # å½“å‰ vfp çš„æœ€ç»ˆ Framework è·¯å¾„
      current_final_framework = "#{current_build_output}/HearonTestSDK.framework"
      
      # é¡¹ç›®è·¯å¾„ï¼ˆå›ºå®šï¼Œå¯å…±äº«ï¼‰
      project_path = "../HearonTestSDK.xcodeproj"
      unless File.exist?(project_path)
        UI.error("âŒ é¡¹ç›®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡å½“å‰ vfp å¤„ç†")
        next
      end

      begin
        # --------------------------
        # æ­¥éª¤3ï¼šç”Ÿæˆå½“å‰ vfp çš„å¯†é’¥æ–‡ä»¶ï¼ˆå¾ªç¯å†…æ‰§è¡Œï¼‰
        # --------------------------
        UI.message("ğŸ”‘ ç”Ÿæˆå½“å‰ vfp çš„å¯†é’¥æ–‡ä»¶...")
        secret_content = <<~SWIFT
          // è‡ªåŠ¨ç”Ÿæˆï¼Œå¯¹åº”ç¬¬ #{index + 1} ä¸ª vfp
          internal let CustomFrameworkSecretKey = "#{current_vfp}"
        SWIFT
        File.write(secret_file_path, secret_content)
        UI.success("âœ… å¯†é’¥æ–‡ä»¶ç”Ÿæˆï¼š#{secret_file_path}")

        # --------------------------
        # æ­¥éª¤4ï¼šæ¸…ç†å½“å‰ vfp çš„æ„å»ºç¼“å­˜ï¼ˆå¾ªç¯å†…æ‰§è¡Œï¼Œé¿å…æ®‹ç•™ï¼‰
        # --------------------------
        UI.message("ğŸ§¹ æ¸…ç†å½“å‰ vfp çš„æ„å»ºç¼“å­˜...")
        clean_command = <<~CMD
          xcodebuild clean \
          -project "#{project_path}" \
          -scheme HearonTestSDK \
          -configuration Debug
        CMD
        # æ‰§è¡Œæ¸…ç†å‘½ä»¤ï¼Œè¾“å‡ºæ—¥å¿—åˆ°å½“å‰å·¥ä½œç›®å½•
        system("#{clean_command} > #{current_work_dir}/clean_log.txt 2>&1")
        UI.success("âœ… æ¸…ç†å®Œæˆï¼ˆæ—¥å¿—ï¼š#{current_work_dir}/clean_log.txtï¼‰")

        # --------------------------
        # æ­¥éª¤5ï¼šç¼–è¯‘å½“å‰ vfp çš„çœŸæœºFrameworkï¼ˆå¾ªç¯å†…æ‰§è¡Œï¼Œå®Œå…¨ç‹¬ç«‹ï¼‰
        # --------------------------
        UI.message("ğŸ”¨ å¼€å§‹ç¼–è¯‘å½“å‰ vfp çš„ Framework...")
        derived_framework_path = ""

        # æ–¹æ¡ˆ1ï¼šä¼˜å…ˆä½¿ç”¨ archiveï¼ˆè¾“å‡ºåˆ°å½“å‰å·¥ä½œç›®å½•ï¼‰
        archive_path = "#{current_work_dir}/HearonTestSDK.xcarchive"
        archive_command = <<~CMD
          xcodebuild archive \
          -project "#{project_path}" \
          -scheme HearonTestSDK \
          -configuration Release \
          -sdk iphoneos \
          -archivePath "#{archive_path}" \
          SKIP_INSTALL=NO \
          BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
          GCC_PREPROCESSOR_DEFINITIONS="SECRET_KEY_FILE=#{secret_file_path}"
        CMD
        # æ‰§è¡Œ archive å‘½ä»¤ï¼Œæ—¥å¿—è¾“å‡ºåˆ°å½“å‰å·¥ä½œç›®å½•
        system("#{archive_command} > #{current_work_dir}/archive_log.txt 2>&1")

        # æ£€æŸ¥ archive äº§ç‰©
        archive_framework_path = "#{archive_path}/Products/Library/Frameworks/HearonTestSDK.framework"
        if File.exist?(archive_framework_path)
          UI.success("âœ… Archive ç¼–è¯‘æˆåŠŸ")
          derived_framework_path = archive_framework_path
        else
          # æ–¹æ¡ˆ2ï¼šå›é€€åˆ° build å‘½ä»¤ï¼ˆè¾“å‡ºåˆ°å½“å‰å·¥ä½œç›®å½•ï¼‰
          UI.message("ğŸ“¦ archive äº§ç‰©æœªæ‰¾åˆ°ï¼Œå°è¯• build å‘½ä»¤...")
          derived_data_path = "#{current_work_dir}/DerivedData"
          build_command = <<~CMD
            xcodebuild build \
            -project "#{project_path}" \
            -scheme HearonTestSDK \
            -configuration Debug \
            -sdk iphoneos \
            -arch arm64 \
            -derivedDataPath "#{derived_data_path}" \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGNING_ALLOWED=NO \
            // å¼ºåˆ¶å¼•ç”¨å½“å‰ vfp çš„å¯†é’¥æ–‡ä»¶
            GCC_PREPROCESSOR_DEFINITIONS="SECRET_KEY_FILE=#{secret_file_path}"
          CMD
          system("#{build_command} > #{current_work_dir}/build_log.txt 2>&1")

          # æ£€æŸ¥ build äº§ç‰©
          derived_framework_path = "#{derived_data_path}/Build/Products/Debug-iphoneos/HearonTestSDK.framework"
          unless File.exist?(derived_framework_path)
            raise "build äº§ç‰©æœªæ‰¾åˆ°ï¼ˆæ—¥å¿—ï¼š#{current_work_dir}/build_log.txtï¼‰"
          end
          UI.success("âœ… Build ç¼–è¯‘æˆåŠŸ")
        end

        # å¤åˆ¶å½“å‰ vfp çš„ Framework åˆ°è¾“å‡ºç›®å½•
        FileUtils.rm_rf(current_final_framework) if File.exist?(current_final_framework)
        FileUtils.cp_r(derived_framework_path, current_final_framework)
        UI.success("ğŸ“¦ ç¬¬ #{index + 1} ä¸ª Framework å·²ä¿å­˜åˆ°ï¼š#{current_final_framework}")

        # éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
        framework_binary = "#{current_final_framework}/HearonTestSDK"
        unless File.exist?(framework_binary)
          raise "Framework å†…æ— äºŒè¿›åˆ¶æ–‡ä»¶ï¼š#{framework_binary}"
        end

        # è¾“å‡ºæ¶æ„ä¿¡æ¯
        arch_info = `lipo -info #{framework_binary} 2>&1`.strip
        if arch_info.include?("arm64")
          UI.success("ğŸ“Š æ¶æ„ä¿¡æ¯ï¼š#{arch_info}")
        else
          UI.important("âš ï¸ æ¶æ„ä¿¡æ¯å¼‚å¸¸ï¼š#{arch_info}")
        end

      rescue => e
        # å•ä¸ª vfp å¤„ç†å¤±è´¥ï¼Œè®°å½•é”™è¯¯åç»§ç»­ä¸‹ä¸€ä¸ª
        UI.error("âŒ ç¬¬ #{index + 1} ä¸ª vfp å¤„ç†å¤±è´¥ï¼š#{e.message}")
        next
      end

      # æ¸…ç†å½“å‰ vfp çš„ä¸´æ—¶å¯†é’¥æ–‡ä»¶ï¼ˆæˆåŠŸåï¼‰
      File.delete(secret_file_path) if File.exist?(secret_file_path)
      UI.success("\nâœ… ç¬¬ #{index + 1} ä¸ª vfp å¤„ç†å®Œæˆ")
    end

    # æ‰€æœ‰ vfp å¤„ç†å®Œæˆåæ±‡æ€»
    UI.success("\nğŸ‰ æ‰€æœ‰ vfp å¤„ç†å®Œæ¯•ï¼")
    UI.success("ğŸ“ æ‰€æœ‰äº§ç‰©è·¯å¾„ï¼š")
    vfp_list.each_with_index do |_, index|
      UI.message("   - ç¬¬ #{index + 1} ä¸ªï¼š#{base_work_dir}/vfp_#{index + 1}/framework/HearonTestSDK.framework")
    end
  end
end