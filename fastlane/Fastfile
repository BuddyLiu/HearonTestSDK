# Fastfile
require 'fileutils'
require 'json'
require 'net/http'

default_platform(:ios)

platform :ios do
  lane :build_framework do |options|
    # 1. æ¥æ”¶å¹¶è§£æ JSON æ ¼å¼å¯†é’¥ï¼Œè·å–æ‰€æœ‰ vfp å­—æ®µï¼ˆä»…è¿™ä¸€æ­¥åœ¨å¾ªç¯å¤–ï¼‰
    secret_json_str = options[:build_users]
    unless secret_json_str
      UI.user_error!("âŒ è¯·ä¼ å…¥ JSON æ ¼å¼å¯†é’¥ï¼šfastlane build_framework build_users:\"{ä½ çš„JSONå­—ç¬¦ä¸²}\"")
    end

    # è§£æ JSON å¹¶æå–æ‰€æœ‰ vfp å­—æ®µ
    begin
      secret_json = JSON.parse(secret_json_str)
      unless secret_json.key?("data") && secret_json["data"].is_a?(Array) && !secret_json["data"].empty?
        UI.user_error!("âŒ JSON æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘æœ‰æ•ˆçš„ data æ•°ç»„")
      end

      # æ”¶é›†æ‰€æœ‰æœ‰æ•ˆçš„ vfp å­—æ®µå’Œå¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯
      user_data_list = secret_json["data"].each_with_index.map do |item, index|
        vfp = item["vfp"]&.to_s&.strip
        account_id = item["id"]&.to_s&.strip
        account_name = item["accountName"]&.to_s&.strip
        channel = item["channel"]&.to_s&.strip
        
        unless vfp && !vfp.empty?
          UI.user_error!("âŒ JSON æ ¼å¼é”™è¯¯ï¼šdata æ•°ç»„ç¬¬ #{index + 1} ä¸ªå…ƒç´ ç¼ºå°‘æœ‰æ•ˆçš„ vfp å­—æ®µ")
        end
        unless account_id && !account_id.empty?
          UI.user_error!("âŒ JSON æ ¼å¼é”™è¯¯ï¼šdata æ•°ç»„ç¬¬ #{index + 1} ä¸ªå…ƒç´ ç¼ºå°‘æœ‰æ•ˆçš„ id å­—æ®µ")
        end
        
        {
          vfp: vfp,
          account_id: account_id,
          account_name: account_name || "æœªçŸ¥ç”¨æˆ·",
          channel: channel || "default_channel"
        }
      end

      UI.success("âœ… æˆåŠŸè§£æ JSON å¯†é’¥ï¼Œå…±è·å– #{user_data_list.size} ä¸ªç”¨æˆ·æ•°æ®ï¼Œå¼€å§‹å¾ªç¯å¤„ç†...")
    rescue JSON::ParserError => e
      UI.user_error!("âŒ JSON è§£æå¤±è´¥ï¼š#{e.message}")
    end

    # åŸºç¡€è·¯å¾„ï¼ˆå¾ªç¯å¤–å®šä¹‰å…¬å…±æ ¹ç›®å½•ï¼‰
    base_work_dir = "./build_multi_vfp_#{Time.now.strftime('%Y%m%d_%H%M%S')}"
    FileUtils.mkdir_p(base_work_dir)
    UI.message("ğŸ“‚ æ‰€æœ‰æ„å»ºçš„æ ¹ç›®å½•ï¼š#{base_work_dir}")

    # 2. éå†æ¯ä¸ªç”¨æˆ·æ•°æ®ï¼Œå°†æ­¥éª¤2-7å…¨éƒ¨çº³å…¥å¾ªç¯
    user_data_list.each_with_index do |user_data, index|
      current_vfp = user_data[:vfp]
      UI.message("\n\n==================================================")
      UI.message("ğŸ”„ å¼€å§‹å¤„ç†ç¬¬ #{index + 1}/#{user_data_list.size} ä¸ªç”¨æˆ·ï¼š#{user_data[:account_name]}ï¼ˆ#{current_vfp[0, 6]}...ï¼‰")
      UI.message("==================================================\n")

      # --------------------------
      # æ­¥éª¤2ï¼šå½“å‰ vfp çš„è·¯å¾„é…ç½®ï¼ˆå¾ªç¯å†…å®šä¹‰ï¼Œå®Œå…¨éš”ç¦»ï¼‰
      # --------------------------
      # å½“å‰ vfp çš„ç‹¬ç«‹å·¥ä½œç›®å½•ï¼ˆæ‰€æœ‰æ–‡ä»¶å‡åœ¨æ­¤ç›®å½•ï¼Œé¿å…äº¤å‰æ±¡æŸ“ï¼‰
      current_work_dir = "#{base_work_dir}/vfp_#{index + 1}"
      FileUtils.mkdir_p(current_work_dir)

      # å½“å‰ vfp çš„å¯†é’¥æ–‡ä»¶è·¯å¾„ï¼ˆç‹¬ç«‹è·¯å¾„ï¼Œé¿å…è¦†ç›–ï¼‰
      secret_file_path = "../HearonTestSDK/HearonTestSDK/SecretKey.swift"
      
      # å½“å‰ vfp çš„ç¼–è¯‘è¾“å‡ºç›®å½•
      current_build_output = "#{current_work_dir}/framework"
      FileUtils.mkdir_p(current_build_output)
      
      # å½“å‰ vfp çš„æœ€ç»ˆ Framework è·¯å¾„
      current_final_framework = "#{current_build_output}/HearonTestSDK.framework"
      
      # é¡¹ç›®è·¯å¾„ï¼ˆå›ºå®šï¼Œå¯å…±äº«ï¼‰
      project_path = "../HearonTestSDK.xcodeproj"
      unless File.exist?(project_path)
        UI.error("âŒ é¡¹ç›®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡å½“å‰ç”¨æˆ·å¤„ç†")
        next
      end

      begin
        # --------------------------
        # æ­¥éª¤3ï¼šç”Ÿæˆå½“å‰ vfp çš„å¯†é’¥æ–‡ä»¶ï¼ˆå¾ªç¯å†…æ‰§è¡Œï¼‰
        # --------------------------
        UI.message("ğŸ”‘ ç”Ÿæˆå½“å‰ vfp çš„å¯†é’¥æ–‡ä»¶...")
        secret_content = <<~SWIFT
          // è‡ªåŠ¨ç”Ÿæˆï¼Œå¯¹åº”ç¬¬ #{index + 1} ä¸ªç”¨æˆ·ï¼š#{user_data[:account_name]}
          internal let CustomFrameworkSecretKey = "#{current_vfp}"
        SWIFT
        File.write(secret_file_path, secret_content)
        UI.success("âœ… å¯†é’¥æ–‡ä»¶ç”Ÿæˆï¼š#{secret_file_path}")

        # --------------------------
        # æ­¥éª¤4ï¼šæ¸…ç†å½“å‰ vfp çš„æ„å»ºç¼“å­˜ï¼ˆå¾ªç¯å†…æ‰§è¡Œï¼Œé¿å…æ®‹ç•™ï¼‰
        # --------------------------
        UI.message("ğŸ§¹ æ¸…ç†å½“å‰ vfp çš„æ„å»ºç¼“å­˜...")
        clean_command = <<~CMD
          xcodebuild clean \
          -project "#{project_path}" \
          -scheme HearonTestSDK \
          -configuration Debug
        CMD
        # æ‰§è¡Œæ¸…ç†å‘½ä»¤ï¼Œè¾“å‡ºæ—¥å¿—åˆ°å½“å‰å·¥ä½œç›®å½•
        system("#{clean_command} > #{current_work_dir}/clean_log.txt 2>&1")
        UI.success("âœ… æ¸…ç†å®Œæˆï¼ˆæ—¥å¿—ï¼š#{current_work_dir}/clean_log.txtï¼‰")

        # --------------------------
        # æ­¥éª¤5ï¼šç¼–è¯‘å½“å‰ vfp çš„çœŸæœºFrameworkï¼ˆå¾ªç¯å†…æ‰§è¡Œï¼Œå®Œå…¨ç‹¬ç«‹ï¼‰
        # --------------------------
        UI.message("ğŸ”¨ å¼€å§‹ç¼–è¯‘å½“å‰ vfp çš„ Framework...")
        derived_framework_path = ""

        # æ–¹æ¡ˆ1ï¼šä¼˜å…ˆä½¿ç”¨ archiveï¼ˆè¾“å‡ºåˆ°å½“å‰å·¥ä½œç›®å½•ï¼‰
        archive_path = "#{current_work_dir}/HearonTestSDK.xcarchive"
        archive_command = <<~CMD
          xcodebuild archive \
          -project "#{project_path}" \
          -scheme HearonTestSDK \
          -configuration Release \
          -sdk iphoneos \
          -archivePath "#{archive_path}" \
          SKIP_INSTALL=NO \
          BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
          GCC_PREPROCESSOR_DEFINITIONS="SECRET_KEY_FILE=#{secret_file_path}"
        CMD
        # æ‰§è¡Œ archive å‘½ä»¤ï¼Œæ—¥å¿—è¾“å‡ºåˆ°å½“å‰å·¥ä½œç›®å½•
        system("#{archive_command} > #{current_work_dir}/archive_log.txt 2>&1")

        # æ£€æŸ¥ archive äº§ç‰©
        archive_framework_path = "#{archive_path}/Products/Library/Frameworks/HearonTestSDK.framework"
        if File.exist?(archive_framework_path)
          UI.success("âœ… Archive ç¼–è¯‘æˆåŠŸ")
          derived_framework_path = archive_framework_path
        else
          # æ–¹æ¡ˆ2ï¼šå›é€€åˆ° build å‘½ä»¤ï¼ˆè¾“å‡ºåˆ°å½“å‰å·¥ä½œç›®å½•ï¼‰
          UI.message("ğŸ“¦ archive äº§ç‰©æœªæ‰¾åˆ°ï¼Œå°è¯• build å‘½ä»¤...")
          derived_data_path = "#{current_work_dir}/DerivedData"
          build_command = <<~CMD
            xcodebuild build \
            -project "#{project_path}" \
            -scheme HearonTestSDK \
            -configuration Debug \
            -sdk iphoneos \
            -arch arm64 \
            -derivedDataPath "#{derived_data_path}" \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGNING_ALLOWED=NO \
            GCC_PREPROCESSOR_DEFINITIONS="SECRET_KEY_FILE=#{secret_file_path}"
          CMD
          system("#{build_command} > #{current_work_dir}/build_log.txt 2>&1")

          # æ£€æŸ¥ build äº§ç‰©
          derived_framework_path = "#{derived_data_path}/Build/Products/Debug-iphoneos/HearonTestSDK.framework"
          unless File.exist?(derived_framework_path)
            raise "build äº§ç‰©æœªæ‰¾åˆ°ï¼ˆæ—¥å¿—ï¼š#{current_work_dir}/build_log.txtï¼‰"
          end
          UI.success("âœ… Build ç¼–è¯‘æˆåŠŸ")
        end

        # å¤åˆ¶å½“å‰ vfp çš„ Framework åˆ°è¾“å‡ºç›®å½•
        FileUtils.rm_rf(current_final_framework) if File.exist?(current_final_framework)
        FileUtils.cp_r(derived_framework_path, current_final_framework)
        UI.success("ğŸ“¦ ç¬¬ #{index + 1} ä¸ª Framework å·²ä¿å­˜åˆ°ï¼š#{current_final_framework}")

        # éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
        framework_binary = "#{current_final_framework}/HearonTestSDK"
        unless File.exist?(framework_binary)
          raise "Framework å†…æ— äºŒè¿›åˆ¶æ–‡ä»¶ï¼š#{framework_binary}"
        end

        # è¾“å‡ºæ¶æ„ä¿¡æ¯
        arch_info = `lipo -info #{framework_binary} 2>&1`.strip
        if arch_info.include?("arm64")
          UI.success("ğŸ“Š æ¶æ„ä¿¡æ¯ï¼š#{arch_info}")
        else
          UI.important("âš ï¸ æ¶æ„ä¿¡æ¯å¼‚å¸¸ï¼š#{arch_info}")
        end

        # --------------------------
        # æ­¥éª¤6ï¼šå‹ç¼© Framework å¹¶ä¸Šä¼ 
        # --------------------------
        UI.message("ğŸ“¦ å¼€å§‹å‹ç¼© Framework...")
        
        # å‹ç¼©æ–‡ä»¶è·¯å¾„
        zip_file_path = "#{current_work_dir}/framework/HearonTestSDK.zip"
        
        UI.message("å‹ç¼©è·¯å¾„: #{zip_file_path}")

        # ä¿®å¤å‹ç¼©å‘½ä»¤ï¼šä¸ä½¿ç”¨ cdï¼Œç›´æ¥æŒ‡å®šå®Œæ•´è·¯å¾„
        zip_command = "ditto -c -k --sequesterRsrc --keepParent \"#{current_final_framework}\" \"#{zip_file_path}\""
        UI.message("å‹ç¼©å‘½ä»¤: #{zip_command}")

        zip_success = system("#{zip_command} > \"#{current_work_dir}/zip_log.txt\" 2>&1")
        
        unless zip_success && File.exist?(zip_file_path)
          # è¯»å–å‹ç¼©æ—¥å¿—ä»¥ä¾¿æ›´å¥½çš„é”™è¯¯ä¿¡æ¯
          zip_log_content = File.exist?("#{current_work_dir}/zip_log.txt") ? File.read("#{current_work_dir}/zip_log.txt") : "æ— æ—¥å¿—æ–‡ä»¶"
          raise "Framework å‹ç¼©å¤±è´¥ï¼ˆæ—¥å¿—ï¼š#{zip_log_content}ï¼‰"
        end
        
        zip_file_size = File.size(zip_file_path)
        UI.success("âœ… å‹ç¼©å®Œæˆï¼š#{zip_file_path} (#{zip_file_size / 1024 / 1024} MB)")

        # # ä¸Šä¼ æ–‡ä»¶
        UI.message("ğŸŒ å¼€å§‹ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨...")
        upload_result = upload_file(zip_file_path)
        
        unless upload_result && upload_result["code"] == 0 && upload_result["data"]["list"][0]["file_id"] && upload_result["data"]["list"][0]["upload_file_url"]
          raise "æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼š#{upload_result}"
        end
        
        file_id = upload_result["data"]["list"][0]["file_id"]
        file_url = upload_result["data"]["list"][0]["upload_file_url"]
        UI.success("âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ")
        UI.message("File ID: #{file_id}")
        UI.message("File URL: #{file_url}")

        # --------------------------
        # æ­¥éª¤7ï¼šè°ƒç”¨ä¿å­˜å…³ç³»æ¥å£
        # --------------------------
        UI.message("ğŸ’¾ å¼€å§‹ä¿å­˜åŒ…å…³ç³»ä¿¡æ¯...")
        
        save_params = {
          account_id: user_data[:account_id],
          account_name: user_data[:account_name],
          pkg_id: file_id,
          pkg_url: file_url,
          pkg_version: "1.0", # å›ºå®šç‰ˆæœ¬å·
          channel: user_data[:channel]
        }
        UI.message("è°ƒç”¨å‚æ•°ï¼š#{save_params}")
        save_result = save_account_pkg_relation(save_params)
        
        if save_result && save_result["data"]["succTag"]
          UI.success("âœ… åŒ…å…³ç³»ä¿å­˜æˆåŠŸ")
        else
          error_msg = save_result ? save_result["data"]["msg"] || save_result.to_s : "æœªçŸ¥é”™è¯¯"
          UI.error("âŒ åŒ…å…³ç³»ä¿å­˜å¤±è´¥ï¼š#{error_msg}")
        end

      rescue => e
        # å•ä¸ªç”¨æˆ·å¤„ç†å¤±è´¥ï¼Œè®°å½•é”™è¯¯åç»§ç»­ä¸‹ä¸€ä¸ª
        UI.error("âŒ ç¬¬ #{index + 1} ä¸ªç”¨æˆ·å¤„ç†å¤±è´¥ï¼š#{e.message}")
        UI.error("Backtrace: #{e.backtrace.join("\n")}") if e.backtrace
        next
      ensure
        # æ¸…ç†å½“å‰ vfp çš„ä¸´æ—¶å¯†é’¥æ–‡ä»¶ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥ï¼‰
        File.delete(secret_file_path) if File.exist?(secret_file_path)
      end

      UI.success("\nâœ… ç¬¬ #{index + 1} ä¸ªç”¨æˆ· #{user_data[:account_name]} å¤„ç†å®Œæˆ")
    end

    # æ‰€æœ‰ç”¨æˆ·å¤„ç†å®Œæˆåæ±‡æ€»
    UI.success("\nğŸ‰ æ‰€æœ‰ç”¨æˆ·å¤„ç†å®Œæ¯•ï¼")
    UI.success("ğŸ“ æ‰€æœ‰äº§ç‰©è·¯å¾„ï¼š")
    user_data_list.each_with_index do |user_data, index|
      safe_name = user_data[:account_name].gsub(/[^\w]/, '_')
      UI.message("   - ç¬¬ #{index + 1} ä¸ª (#{user_data[:account_name]}): #{base_work_dir}/vfp_#{index + 1}_#{safe_name}/framework/HearonTestSDK.framework")
    end
  end

  # ä¸Šä¼ æ–‡ä»¶æ–¹æ³•
  def upload_file(file_path)
    # è¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…ä¸Šä¼ æ¥å£ URL
    upload_url = "https://sit-soc.uim-solution.com/cvn/app/upload_file"
    
    uri = URI.parse(upload_url)
    http = Net::HTTP.new(uri.host, uri.port)
    http.use_ssl = (uri.scheme == 'https')

    # åˆ›å»º multipart è¯·æ±‚
    boundary = "----WebKitFormBoundary#{Time.now.to_i}"
    
    # æ„å»º multipart è¯·æ±‚ä½“
    post_body = []
    post_body << "--#{boundary}\r\n"
    post_body << "Content-Disposition: form-data; name=\"file\"; filename=\"#{File.basename(file_path)}\"\r\n"
    post_body << "Content-Type: application/zip\r\n\r\n"
    post_body << File.binread(file_path)
    post_body << "\r\n--#{boundary}--\r\n"
    
    request = Net::HTTP::Post.new(uri.request_uri)
    request.body = post_body.join
    request["Content-Type"] = "multipart/form-data; boundary=#{boundary}"
    
    # æ·»åŠ å¿…è¦çš„ headersï¼ˆæ ¹æ® curl å‘½ä»¤ï¼‰
    request["X-UIM-device-id"] = "1"
    request["X-UIM-device-manufacturer"] = "1"
    request["X-UIM-device-brand"] = "1"
    request["X-UIM-device-model"] = "1"
    request["X-UIM-os-type"] = "1"
    request["X-UIM-os-version"] = "1"
    request["X-UIM-client-id"] = "1"
    request["X-UIM-client-version"] = "1"
    request["X-UIM-client-code"] = "1"
    
    begin
      response = http.request(request)
      
      if response.code == "200"
        JSON.parse(response.body)
      else
        UI.error("ä¸Šä¼ æ¥å£è¿”å›é”™è¯¯: #{response.code} - #{response.body}")
        nil
      end
    rescue => e
      UI.error("ä¸Šä¼ è¯·æ±‚å¼‚å¸¸: #{e.message}")
      nil
    end
  end

  # ä¿å­˜åŒ…å…³ç³»æ–¹æ³•
  def save_account_pkg_relation(params)
    # è¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…ä¿å­˜æ¥å£ URL
    save_url = "https://sit-soc.uim-solution.com/cvn/app/save_account_pkg_relation"
    
    uri = URI.parse(save_url)
    http = Net::HTTP.new(uri.host, uri.port)
    http.use_ssl = (uri.scheme == 'https')
    
    request = Net::HTTP::Post.new(uri.request_uri, 'Content-Type' => 'application/json',
                                  'X-UIM-device-id' => '1',
                                  'X-UIM-device-manufacturer' => '1',
                                  'X-UIM-device-brand' => '1',
                                  'X-UIM-device-model' => '1',
                                  'X-UIM-os-type' => '1',
                                  'X-UIM-os-version' => '1',
                                  'X-UIM-client-id' => '1',
                                  'X-UIM-client-version' => '1',
                                  'X-UIM-client-code' => '1',
                                  'Cookie' => '1')
    request.body = {data: {
      account_id: params[:account_id],
      account_name: params[:account_name],
      pkg_id: params[:pkg_id],
      pkg_url: params[:pkg_url],
      pkg_version: params[:pkg_version],
      channel: params[:channel]
    }, echo: "111"}.to_json
    
    UI.message("ä¿å­˜å…³ç³»è¯·æ±‚ä½“: #{request.body}")

    begin
      response = http.request(request)
      
      UI.message("ä¿å­˜å…³ç³»æ¥å£è¿”å›: #{response.code} - #{response.body}")

      if response.code == "200"
        JSON.parse(response.body)
      else
        UI.error("ä¿å­˜å…³ç³»æ¥å£è¿”å›é”™è¯¯: #{response.code} - #{response.body}")
        nil
      end
    rescue => e
      UI.error("ä¿å­˜å…³ç³»è¯·æ±‚å¼‚å¸¸: #{e.message}")
      nil
    end
  end
end
