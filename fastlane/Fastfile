# Fastfile
require 'fileutils'

default_platform(:ios)

platform :ios do
  lane :build_framework do |options|
    # 1. æ¥æ”¶å¯†é’¥
    secret_key = options[:secret_key]
    unless secret_key
      UI.user_error!("âŒ è¯·ä¼ å…¥å¯†é’¥ï¼šfastlane build_framework secret_key:\"ä½ çš„å¯†é’¥\"")
    end

    # 2. è·¯å¾„é…ç½®
    secret_file_path = File.expand_path("../../HearonTestSDK/HearonTestSDK/SecretKey.swift", __FILE__)
    derived_framework_path = "/Users/bo.liu/Library/Developer/Xcode/DerivedData/HearonTestSDK-gsuroojostvaokczdsdxudxwdbif/Build/Products/Debug-iphoneos/HearonTestSDK.framework"
    build_output_dir = "./build/device"
    final_framework_path = "#{build_output_dir}/HearonTestSDK.framework"

    # 3. ç”Ÿæˆå¯†é’¥æ–‡ä»¶
    begin
      secret_content = "// è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿ä¿®æ”¹\ninternal let CustomFrameworkSecretKey = \"#{secret_key}\""
      FileUtils.mkdir_p(File.dirname(secret_file_path))
      File.write(secret_file_path, secret_content)
      UI.success("âœ… å¯†é’¥æ–‡ä»¶ç”Ÿæˆï¼š#{secret_file_path}")
    rescue => e
      UI.user_error!("âŒ ç”Ÿæˆå¯†é’¥æ–‡ä»¶å¤±è´¥ï¼š#{e.message}")
    end

    # 4. æ¸…ç†ä¹‹å‰çš„æ„å»º
    begin
      UI.message("ğŸ§¹ æ¸…ç†ä¹‹å‰çš„æ„å»º...")
      clean_command = <<~CMD
        xcodebuild clean \
        -project "../HearonTestSDK.xcodeproj" \
        -scheme HearonTestSDK \
        -configuration Debug
      CMD
      system(clean_command)
      UI.success("âœ… æ¸…ç†å®Œæˆ")
    rescue => e
      UI.message("âš ï¸ æ¸…ç†è¿‡ç¨‹ä¸­å‡ºç°è­¦å‘Šï¼š#{e.message}")
    end

    # 5. ç¼–è¯‘çœŸæœºFramework - ä¿®å¤ç‰ˆæœ¬
    begin
      project_path = "../HearonTestSDK.xcodeproj"
      unless File.exist?(project_path)
        raise "é¡¹ç›®æ–‡ä»¶ä¸å­˜åœ¨ï¼š#{File.expand_path(project_path)}"
      end

      UI.message("ğŸ”¨ å¼€å§‹ç¼–è¯‘Framework...")

      # æ–¹æ¡ˆ1: ä½¿ç”¨ archive å‘½ä»¤ï¼ˆæ¨èï¼‰
      archive_command = <<~CMD
        xcodebuild archive \
        -project "#{project_path}" \
        -scheme HearonTestSDK \
        -configuration Debug \
        -sdk iphoneos \
        -archivePath "./build/HearonTestSDK-iphoneos.xcarchive" \
        SKIP_INSTALL=NO \
        BUILD_LIBRARY_FOR_DISTRIBUTION=YES
      CMD

      UI.message("æ‰§è¡Œç¼–è¯‘å‘½ä»¤ï¼š#{archive_command}")
      
      # ä½¿ç”¨ fastlane çš„ sh å‘½ä»¤æ¥è·å¾—æ›´å¥½çš„è¾“å‡ºå¤„ç†
      sh(archive_command)
      
      # æ£€æŸ¥archiveäº§ç‰©
      archive_framework_path = "./build/HearonTestSDK-iphoneos.xcarchive/Products/Library/Frameworks/HearonTestSDK.framework"
      if File.exist?(archive_framework_path)
        UI.success("âœ… Archive ç¼–è¯‘æˆåŠŸ")
        derived_framework_path = archive_framework_path
      else
        # æ–¹æ¡ˆ2: å›é€€åˆ° build å‘½ä»¤
        UI.message("ğŸ“¦ å°è¯•ä½¿ç”¨ build å‘½ä»¤...")
        build_command = <<~CMD
          xcodebuild build \
          -project "#{project_path}" \
          -scheme HearonTestSDK \
          -configuration Debug \
          -sdk iphoneos \
          -arch arm64 \
          -derivedDataPath "./build/DerivedData" \
          ONLY_ACTIVE_ARCH=NO \
          CODE_SIGNING_ALLOWED=NO
        CMD
        
        sh(build_command)
        
        # æ£€æŸ¥DerivedDataä¸­çš„äº§ç‰©
        derived_framework_path = "./build/DerivedData/Build/Products/Debug-iphoneos/HearonTestSDK.framework"
        unless File.exist?(derived_framework_path)
          raise "ç¼–è¯‘å¤±è´¥ï¼Œæœªæ‰¾åˆ°Frameworkæ–‡ä»¶"
        end
        UI.success("âœ… Build ç¼–è¯‘æˆåŠŸ")
      end
      
    rescue => e
      File.delete(secret_file_path) if File.exist?(secret_file_path)
      UI.user_error!("âŒ ç¼–è¯‘å¤±è´¥ï¼š#{e.message}")
    end

    # 6. éªŒè¯å¹¶å¤åˆ¶Framework
    unless File.exist?(derived_framework_path)
      File.delete(secret_file_path) if File.exist?(secret_file_path)
      UI.user_error!("âŒ Frameworkè·¯å¾„ä¸å­˜åœ¨ï¼š#{derived_framework_path}")
    end

    FileUtils.mkdir_p(build_output_dir)
    FileUtils.rm_rf(final_framework_path) if File.exist?(final_framework_path)
    FileUtils.cp_r(derived_framework_path, build_output_dir)
    UI.success("ğŸ“‹ å·²å¤åˆ¶Frameworkåˆ°è¾“å‡ºç›®å½•")

    # 7. éªŒè¯äºŒè¿›åˆ¶å¹¶è¾“å‡ºç»“æœ
    framework_binary = "#{final_framework_path}/HearonTestSDK"
    unless File.exist?(framework_binary)
      File.delete(secret_file_path) if File.exist?(secret_file_path)
      UI.user_error!("âŒ Frameworkå†…æ— äºŒè¿›åˆ¶æ–‡ä»¶ï¼š#{framework_binary}")
    end

    File.delete(secret_file_path) if File.exist?(secret_file_path)
    UI.success("\nğŸ‰ æ„å»ºæˆåŠŸï¼")
    UI.success("ğŸ“¦ æœ€ç»ˆFrameworkè·¯å¾„ï¼š#{final_framework_path}")
    
    open final_framework_path
    
    # è¾“å‡ºæ¶æ„ä¿¡æ¯
    arch_info = `lipo -info #{framework_binary} 2>&1`.strip
    if arch_info.include?("arm64")
      UI.success("ğŸ“Š æ¶æ„ä¿¡æ¯ï¼š#{arch_info}")
    else
      UI.important("âš ï¸ æ¶æ„ä¿¡æ¯å¼‚å¸¸ï¼š#{arch_info}")
    end
  end
end